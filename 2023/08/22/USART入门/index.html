<!doctypehtml><html lang=zh-CN><meta charset=UTF-8><meta content=width=device-width,initial-scale=1,maximum-scale=2 name=viewport><meta content=#222 name=theme-color><meta content="Hexo 6.3.0" name=generator><link href=/images/apple-touch-icon-next.png rel=apple-touch-icon sizes=180x180><link href=/images/favicon-32x32-next.png rel=icon sizes=32x32 type=image/png><link href=/images/favicon-16x16-next.png rel=icon sizes=16x16 type=image/png><link color=#222 href=/images/logo.svg rel=mask-icon><link href=/css/main.css rel=stylesheet><link href=/lib/font-awesome/css/all.min.css rel=stylesheet><script id=hexo-configurations>var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};</script><meta content="Main Takeaway Following 哈工深上传到B站的电控组培训来入门robomaster电控组，我购买了普中科技玄武套餐开发板作为硬件。 本篇介绍我学习USART的见闻——实验仍有一些问题未解决" name=description><meta content=article property=og:type><meta content=USART入门 property=og:title><meta content=http://example.com/2023/08/22/USART%E5%85%A5%E9%97%A8/index.html property=og:url><meta content=Immortal-Fates property=og:site_name><meta content="Main Takeaway Following 哈工深上传到B站的电控组培训来入门robomaster电控组，我购买了普中科技玄武套餐开发板作为硬件。 本篇介绍我学习USART的见闻——实验仍有一些问题未解决" property=og:description><meta content=zh_CN property=og:locale><meta content=2023-08-22T06:36:10.000Z property=article:published_time><meta content=2023-08-22T11:44:57.351Z property=article:modified_time><meta content=Immortal-Fates property=article:author><meta content=嵌入式 property=article:tag><meta content=robomaster property=article:tag><meta content=summary name=twitter:card><link href=http://example.com/2023/08/22/USART%E5%85%A5%E9%97%A8/ rel=canonical><script id=page-configurations>// https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };</script><title>USART入门 | Immortal-Fates</title><noscript><style>.use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }</style></noscript><body itemscope itemtype=http://schema.org/WebPage><div class="container use-motion"><div class=headband></div><header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-brand-container><div class=site-nav-toggle><div aria-label=切换导航栏 class=toggle><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div></div><div class=site-meta><a class=brand href=/ rel=start> <span class=logo-line-before><i></i></span> <h1 class=site-title>Immortal-Fates</h1> <span class=logo-line-after><i></i></span> </a></div><div class=site-nav-right><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class=site-nav><ul class="main-menu menu" id=menu><li class="menu-item menu-item-home"><a href=/ rel=section><i class="fa fa-home fa-fw"></i>首页</a><li class="menu-item menu-item-tags"><a href=/tags/ rel=section><i class="fa fa-tags fa-fw"></i>标签</a><li class="menu-item menu-item-categories"><a href=/categories/ rel=section><i class="fa fa-th fa-fw"></i>分类</a><li class="menu-item menu-item-archives"><a href=/archives/ rel=section><i class="fa fa-archive fa-fw"></i>归档</a><li class="menu-item menu-item-schedule"><a href=/schedule/ rel=section><i class="fa fa-calendar fa-fw"></i>日程表</a><li class="menu-item menu-item-about"><a href=/about/ rel=section><i class="fa fa-user fa-fw"></i>关于</a><li class="menu-item menu-item-search"><a class=popup-trigger role=button><i class="fa fa-search fa-fw"></i>搜索 </a></ul></nav><div class=search-pop-overlay><div class="popup search-popup"><div class=search-header><span class=search-icon> <i class="fa fa-search"></i> </span><div class=search-input-container><input autocapitalize=off autocomplete=off class=search-input placeholder=搜索... spellcheck=false type=search></div><span class=popup-btn-close> <i class="fa fa-times-circle"></i> </span></div><div id=search-result><div id=no-result><i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i></div></div></div></div></div></header><div class=back-to-top><i class="fa fa-arrow-up"></i><span>0%</span></div><a aria-label="Follow me on GitHub" title="Follow me on GitHub" class=github-corner href=https://github.com/Immortal-Fates rel=noopener target=_blank><svg viewbox="0 0 250 250" aria-hidden=true height=80 width=80><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" style="transform-origin: 130px 106px;" class=octo-arm fill=currentColor></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" class=octo-body fill=currentColor></path></svg></a><main class=main><div class=main-inner><div class=content-wrap><div class="content post posts-expand"><article class=post-block itemscope itemtype=http://schema.org/Article lang=zh-CN><link href=http://example.com/2023/08/22/USART%E5%85%A5%E9%97%A8/ itemprop=mainEntityOfPage><span hidden itemprop=author itemscope itemtype=http://schema.org/Person> <meta content=/images/kuang.jpg itemprop=image> <meta content=Immortal-Fates itemprop=name> <meta content=愿你生命中有更多的云翳，来造就一个美丽的黄昏 itemprop=description> </span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization> <meta content=Immortal-Fates itemprop=name> </span><header class=post-header><h1 itemprop="name headline" class=post-title>USART入门</h1><div class=post-meta><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-calendar"></i> </span> <span class=post-meta-item-text>发表于</span> <time itemprop="dateCreated datePublished" title="创建时间：2023-08-22 14:36:10 / 修改时间：19:44:57" datetime=2023-08-22T14:36:10+08:00>2023-08-22</time> </span><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-folder"></i> </span> <span class=post-meta-item-text>分类于</span> <span itemprop=about itemscope itemtype=http://schema.org/Thing> <a href=/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F/ itemprop=url rel=index><span itemprop=name>嵌入式</span></a> </span> </span><span style="display: none;" class=post-meta-item id=busuanzi_container_page_pv title=阅读次数> <span class=post-meta-item-icon> <i class="fa fa-eye"></i> </span> <span class=post-meta-item-text>阅读次数：</span> <span id=busuanzi_value_page_pv></span> </span></div></header><div class=post-body itemprop=articleBody><h1 id=main-takeaway>Main Takeaway</h1><p>Following 哈工深上传到B站的电控组培训来入门robomaster电控组，我购买了普中科技玄武套餐开发板作为硬件。<p>本篇介绍我学习USART的见闻——实验仍有一些问题未解决</p><span id=more></span><h1 id=usart>USART</h1><h2 id=简介>简介</h2><ul><li><p>USART(Universal Synchronous/Asynchronous Receiver/Transmitter)，通用同步(CLK同步接收和发送，数据量大选择)/异步串行接收/发送器</p> <blockquote><p>Tips:UART仅有异步通信</blockquote><li><p>USART是异步串口通信<strong>协议</strong>的一种，工作原理是将传输数据的每个字符一位接一位地传输，它能将要传输的资料在串行通信与并行通信之间加以转换，能够灵活地与外部设备进行全双工数据交换（并行转串行）<li><p>USART有两个引脚用于传输数据，RX和TX，接线的时候应使用交叉线，此外如果是不同设备之间通信还必须有一个GND线，VCC线为可选项。</p> <p>TX(transmitter)：发送数据</p> <p>RX(receiver)：接收数据<li><p>全双工：两条线互不干扰，可同时进行发送和接收 半双工：一次只能进行发送/接收<li><p>异步：只需频率一样，相位可以不一样（常用） 同步：还需时钟线CLK（数据量很大时）<li><p>支持最基本的</p> <ul><li>通用串口同步、异步通讯<li>LIN总线功能（局域互联网）<li>IRDA功能（红外通讯）<li>SmartCard功能</ul><li><p>UART：只有异步通讯</ul><h2 id=usart的通信协议><strong>USART</strong>的通信协议</h2><p>一帧一帧地发送<figure><img alt=USART时序图 src=https://raw.githubusercontent.com/Immortal-Fates/image_host/main/blog/image-20230608114952821.png><figcaption aria-hidden=true>USART时序图</figcaption></figure><ul><li><p>起始位：当未有数据发送时，数据线处于逻辑“1”状态；先发出一个逻辑“0”信号，表示开始传输字符。<li><p>数据位：紧接着起始位之后。数据位的个数可以是4、5、6、7、8等，构成一个字符。通常采用ASCII码。从最低位开始传送，靠时钟定位。</p> <blockquote><p>eg:00010001,先发送1</blockquote><li><p>奇偶校验位：数据为加上这一位后，使得“1”的位数应为偶数（偶校验）或奇数（奇校验），以此来校验资料传送的正确性。(弱校验)<li><p>停止位：它是一个字符数据的结束标志。可以是1位、1.5位、2位的高电平。 由于数据是在传输线上定时的，并且每一个设备有其自己的时钟，很可能在通信中两台设备间出现了小小的不同步。因此停止位不仅仅是<strong>表示传输的结束</strong>，并且<strong>提供计算机校正时钟同步的机会</strong>。适用于停止位的位数越多，不同时钟同步的容忍程度越大，但是数据传输率同时也越慢。<li><p>空闲位或起始位：处于逻辑“1”状态，表示当前线路上没有资料传送，进入空闲状态。处于逻辑“0”状态，表示开始传送下一数据段(起始位)。<li><p>波特率：即每秒传输的二进制位数， 用 b/s (bps)表示，通过对时钟的控制可以改变波特率。USART具有<strong>独立</strong>的高精度波特率发生器，不占用定时/计数器。常用的波特率有：9600、115200……</p> <blockquote><p>Notes:奇偶校验是弱校验，115200最常用，发送/接收的FIFO（CPU太快了 ）</blockquote></ul><h2 id=usart工作原理><strong>USART</strong>工作原理</h2><figure><img alt=image-20230608115210441 src=https://raw.githubusercontent.com/Immortal-Fates/image_host/main/blog/image-20230608115210441.png><figcaption aria-hidden=true>image-20230608115210441</figcaption></figure><h3 id=fifo-操作>FIFO 操作</h3><ul><li><p><strong>INTRO</strong>:FIFO 是“First-In First-Out”的缩写，意为“先进先出”，是一种常见的队列操作。Stellaris 系列ARM 的UART 模块包含有2 个16 字节的FIFO：一个用于发送，另一个用于接收。可以将两个FIFO 分别配置为以不同深度触发中断。可供选择的配置包括：1/8、 1/4、1/2、3/4 和7/8 深度。</p> <blockquote><p>Tips:例如，如果接收FIFO选择1/4，则在UART 接收到4 个数据时产生接收中断</blockquote><li><p>目的：收发FIFO 主要是为了解决UART 收发中断过于频繁而导致CPU 效率不高的问题而引入的。</p> <p>在进行UART通信时，中断方式比轮询方式(polling)要简便且效率高。但是，如果没有收发 FIFO，则每收发一个数据都要中断处理一次，效率仍然不够高。如果有了收发FIFO，则可以在连续收发若干个数据（可多至14 个）后才产生一次中断然后一并处理，这就大大提高了收发效率。<li><p>发送FIFO的基本工作过程：</p> <ul><li><p>只要有数据填充到发送FIFO 里，就会立即启动发送过程。<li><p>由于发送本身是个相对缓慢的过程，因此在发送的同时其它需要发送的数据还可以继续填充到发送 FIFO 里。</p> <blockquote><p>Tips:当发送 FIFO 被填满时就不能再继续填充了，否则会造成数据丢失，此时只能等待。</blockquote><li><p>发送 FIFO 会按照填入数据的先后顺序把数据一个个发送出去，直到发送 FIFO 全空时为止。已发送完毕的数据会被自动清除，在发送FIFO 里同时会多出一个空位。</ul><li><p>接收FIFO的基本工作过程：</p> <ul><li><p>当硬件逻辑接收到数据时，就会往接收FIFO 里填充接收到的数据。<li><p>程序应当及时取走这些数据，数据被取走也是在接收FIFO 里被自动删除的过程，因此在接收 FIFO 里同时会多出一个空位。</p> <blockquote><p>Tips:如果在接收 FIFO 里的数据未被及时取走而造成接收FIFO 已满，则以后再接收到数据时因无空位可以填充而造成数据丢失。</blockquote></ul><li><p><strong>Notes:</strong>完全不必要担心FIFO 机制可能带来的数据丢失或得不到及时处理的问题，因为它已经帮你想到了收发过程中存在的任何问题，只要在初始化配置UART 后，就可以放心收发了， FIFO 和中断例程会自动搞定一切。</ul><h3 id=发送接收>发送接收</h3><ul><li>发送逻辑：从发送FIFO 读取的数据执行“并→串”转换。控制逻辑输出起始位在先的串行位流，并且根据控制寄存器中已编程的配置，后面紧跟着数据位（注意：最低位 LSB 先输出）、奇偶校验位和停止位。<li>接收逻辑：在检测到一个有效的起始脉冲后，对接收到的位流执行“串→并”转换。此外还会对溢出错误、奇偶校验错误、帧错误和线中止（line-break）错误进行检测，并将检测到的状态附加到被写入接收FIFO 的数据中。</ul><h3 id=数据收发过程>数据收发过程</h3><ul><li>发送时，数据被写入发送FIFO。如果USART 被使能，则会按照预先设置好的参数（波特率、数据位、停止位、校验位等）开始发送数据，一直到发送FIFO 中没有数据。一旦向发送FIFO 写数据（如果FIFO 未空），UART 的忙标志位BUSY 就有效，并且在发送数据期间一直保持有效。BUSY 位仅在发送FIFO 为空，且已从移位寄存器发送最后一个字符，包括停止位时才变无效。即 USART 不再使能，它也可以指示忙状态。<li>在USART 接收器空闲时，如果数据输入变成“低电平”，即接收到了起始位，则接收计数器开始运行，若起始位持续时间达到阈值，则起始位有效，否则会被认为是错误的起始位并将其忽略。<li>如果起始位有效，则根据数据字符被编程的长度，对连续的数据位进行采样。如果奇偶校验模式使能，则还会检测奇偶校验位。<li>最后，如果Rx 为高电平，则有效的停止位被确认，否则发生帧错误。当接收到一个完整的字符时，将数据存放在接收FIFO 中。</ul><h3 id=波特率>波特率</h3><ul><li><p>波特率除数（baud-rate divisor）是一个22 位数，它由16 位整数和6 位小数组成，<strong>是一个用来设置USART的通信速度的参数</strong>。波特率发生器使用这两个值组成的数字来决定位周期，决定发送、接收的波特率。</p> <p>通过带有小数波特率的除法器，在足够高的系统时钟速率下，UART 可以产生所有标准的波特率，而误差很小。</ul><blockquote><p>Tips:根据距离的远近设置波特率的大小</blockquote><h3 id=中断控制>中断控制</h3><p>出现以下情况时，可使UART产生中断：<figure><img alt=image-20230608120340707 src=https://raw.githubusercontent.com/Immortal-Fates/image_host/main/blog/image-20230608120340707.png><figcaption aria-hidden=true>image-20230608120340707</figcaption></figure><blockquote><p>Tips:接收数据就绪可读</blockquote><p>由于所有中断事件在发送到中断控制器之前会一起进行“或运算”操作，所以<strong>任意时刻 USART 只能向中断产生一个中断请求</strong>。通过查询中断状态函数，软件可以在同一个中断服务函数里处理多个中断事件（多个并列的if 语句）<p><img src=https://raw.githubusercontent.com/Immortal-Fates/image_host/main/blog/image-20230608120555701.png><h3 id=使用dma收发>使用DMA收发</h3><ul><li><p>DMA（Direct Memory Access，直接内存访问）是一种用于数据传输的技术，它可以绕过CPU直接在外设和内存之间进行数据传输。在DMA操作中，有两个重要的地址：外设基地址和内存基地址。</p> <ul><li>外设基地址是指用于DMA传输的外设设备的起始地址。<li>内存基地址是指用于DMA传输的内存区域的起始地址。</ul> <p>DMA的优点是可以减少CPU的负担，提高系统的效率和性能。</p> <p>DMA的缺点是需要额外的硬件支持，如DMA控制器和总线仲裁器，以及额外的软件配置，如设置DMA通道、传输方向、数据量、优先级等参数。</ul><blockquote><p>Tips:数据传输想象成快递，本来店家需要和快递员一个一个联系，DMA就是快递柜分好类，店家就不用一个一个联系了</blockquote><h2 id=usart重要寄存器>USART重要寄存器</h2><h3 id=状态寄存器usart_sr>状态寄存器（USART_SR）</h3><p>通过查询状态寄存器可查询状态<figure><img alt=image-20230608120652738 src=https://raw.githubusercontent.com/Immortal-Fates/image_host/main/blog/image-20230608120652738.png><figcaption aria-hidden=true>image-20230608120652738</figcaption></figure><ul><li><p>TC：发送完成 (Transmission complete)</p> <p>当包含有数据的一帧发送完成后，并且TXE=1时，由硬件将该位置’1’。如果USART_CR1中的TCIE为’1’，则产生中断。由软件序列清除该位(先读USART_SR，然后写入USART_DR)。 TC位也可以通过写入’0’来清除，只有在多缓存通讯中才推荐这种清除程序。</p> <p>0：发送还未完成；</p> <p>1：发送完成。<li><p>IDLE：监测到总线空闲 (IDLE line detected)</p> <p>当检测到总线空闲时，该位被硬件置位。如果USART_CR1中的IDLEIE为’1’，则产生中断。由软件序列清除该位(先读USART_SR，然后读USART_DR)。</p> <p>0：没有检测到空闲总线；</p> <p>1：检测到空闲总线。</p> <blockquote><p>Tips： IDLE用于不知道到底有多少个字节，IDLE位不会再次被置高,直到RXNE位被置起(即又检测到一次空闲总线)</blockquote></ul><h3 id=控制寄存器-usart_crx>控制寄存器 （USART_CRx）</h3><p>有CR1、CR2、CR3三个寄存器，具体的配置较复杂，具体的可以参考《STM32中文参考手册》。<h2 id=usart-api><strong>USART API</strong></h2><h3 id=接收>接收</h3><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre><td class=code><pre><span class=line>HAL_StatusTypeDef HAL_UART_Receive(UART_HandleTypeDef *huart, uint8_t *pData,uint16_t Size, uint32_t Timeout)</span><br><span class=line>串口接收数据的库函数，阻塞的方式接收数据。</span><br><span class=line></span><br><span class=line>huart :要发送数据的串口指针，pData:接收数据缓存地址，注意此处的指针形式，Size:接收数据的长度（字节数） Timeout：数据接收等待时间，CPU等待这个时间用来接收数据。</span><br></pre></table></figure><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>HAL_StatusTypeDef HAL_UART_Receive_IT(UART_HandleTypeDef *huart, uint8_t *pData,uint16_t Size)</span><br></pre></table></figure><p>使用中断的方式进行接受数据，在这里需要注意的一个点是，使用中断的方式接收到数据之后，需要在中断里面在调用一次HAL_UART_Receive_IT函数，重新开启下一次数据接收，否则会导致，接收完一次数据之后，不会接收下一次数据。<figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br></pre><td class=code><pre><span class=line>HAL_UART_Receive_IT(&huart2,&usart2_rdata,1);  </span><br><span class=line>//IT：interrupt type control，中断</span><br><span class=line>void HAL_UART_RxCpltCallback(UART_HandleTypeDef *huart)  </span><br><span class=line>{</span><br><span class=line>	if(huart->Instance == USART2)  //串口屏，接收中断</span><br><span class=line>	{</span><br><span class=line>	HAL_UART_Receive_IT(&huart2,&usart2_rdata,1);</span><br><span class=line>	}</span><br><span class=line>}</span><br><span class=line>//接收到指定长度就会产生一次中断</span><br></pre></table></figure><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre><td class=code><pre><span class=line>HAL_StatusTypeDef HAL_UART_Receive_DMA(UART_HandleTypeDef *huart, uint8_t*pData, uint16_t Size)</span><br><span class=line>//接收到指定长度就会产生一次中断</span><br></pre></table></figure><h3 id=发送>发送</h3><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre><td class=code><pre><span class=line>HAL_StatusTypeDef HAL_UART_Transmit(UART_HandleTypeDef *huart, uint8_t *pData,uint16_t Size, uint32_t Timeout)</span><br><span class=line>在发送方面，使用HAL_UART_Transmit阻塞数据发送的时候，一定要计算好发送数据的时间。如果发送时间到了，但是数据还没有发送完成的话，会导致没有发送的数据丢失</span><br></pre></table></figure><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>HAL_StatusTypeDef HAL_UART_Transmit_IT(UART_HandleTypeDef *huart, uint8_t*pData, uint16_t Size)</span><br></pre></table></figure><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>HAL_StatusTypeDef HAL_UART_Transmit_DMA(UART_HandleTypeDef *huart, uint8_t*pData, uint16_t Size)</span><br></pre></table></figure><h3 id=中断>中断</h3><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br></pre><td class=code><pre><span class=line>void USART1_IRQHandler(void)</span><br><span class=line>{</span><br><span class=line>/* USER CODE BEGIN USART1_IRQn 0 */</span><br><span class=line>/* USER CODE END USART1_IRQn 0 */</span><br><span class=line>	HAL_UART_IRQHandler(&huart1);</span><br><span class=line>/* USER CODE BEGIN USART1_IRQn 1 */</span><br><span class=line>/* USER CODE END USART1_IRQn 1 */</span><br><span class=line>}</span><br></pre></table></figure><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br></pre><td class=code><pre><span class=line>__weak void HAL_UART_TxCpltCallback(UART_HandleTypeDef *huart)</span><br><span class=line>{</span><br><span class=line>/* Prevent unused argument(s) compilation warning */</span><br><span class=line>	UNUSED(huart);</span><br><span class=line>/* NOTE: This function should not be modified, when the callback is needed,</span><br><span class=line>the HAL_UART_TxCpltCallback could be implemented in the user file*/</span><br><span class=line>}</span><br></pre></table></figure><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br></pre><td class=code><pre><span class=line>__weak void HAL_UART_RxCpltCallback(UART_HandleTypeDef *huart)</span><br><span class=line>{/* Prevent unused argument(s) compilation warning */</span><br><span class=line>	UNUSED(huart);</span><br><span class=line>/* NOTE: This function should not be modified, when the callback is needed,</span><br><span class=line>the HAL_UART_RxCpltCallback could be implemented in the user file*/</span><br><span class=line>}</span><br></pre></table></figure><blockquote><p>Tips:callback函数需要重定义</blockquote><h1 id=实验>实验</h1><h2 id=cubemx>CubeMX：</h2><ul><li><p>串口在Connectivity<li><p>Asynchronous <em>adj.</em>[电] 异步的；不同时的；不同期的<li><p>Parity 奇偶校验位<li><p>NVIC Interrupt打开串口中断<li><p>DMA setting当不知道要接收多少时用DMA空闲中断，ADD->Rx</ul><h2 id=keil>Keil</h2><ul><li>勾选<strong>use micro lib</strong></ul><blockquote><p>Tips:KeilMDK配置项中Use MicroLIB是一个选项，用于选择是否使用microlib库。microlib库是一个简化的C标准库，它专门为需要在极少量内存中运行的深层嵌入式应用程序设计的。microlib库的优点是可以减少代码的大小，但缺点是功能有限，不符合ISO C标准和IEEE 754浮点算法标准。如果你想使用printf等函数，你可以选择Use MicroLIB选项，或者关闭半主机模式并重写相关的底层函数。</blockquote><ul><li>DMA空闲中断</ul><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br></pre><td class=code><pre><span class=line>// 先打开串口空闲中断</span><br><span class=line>__HAL_UART_ENABLE_IT(&huart1, UART_IT_IDLE);</span><br><span class=line>HAL_UART_Receive_DMA(&huart1, receive_data, 100);</span><br><span class=line></span><br><span class=line>//然后重写callback函数</span><br><span class=line>void UART_IDLE_Callback(UART_HandleTypeDef *huart)</span><br><span class=line></span><br><span class=line>//最后在it.c中调用自己的中断，屏蔽默认的中断</span><br><span class=line>void USART1_IRQHandler(void)</span><br><span class=line>{</span><br><span class=line>  /* USER CODE BEGIN USART1_IRQn 0 */</span><br><span class=line>	UART_IDLE_Callback(&huart1);    //调用自己的中断</span><br><span class=line>	return;    //屏蔽默认的中断</span><br><span class=line>  /* USER CODE END USART1_IRQn 0 */</span><br><span class=line>  HAL_UART_IRQHandler(&huart1);</span><br><span class=line>  /* USER CODE BEGIN USART1_IRQn 1 */</span><br><span class=line></span><br><span class=line>  /* USER CODE END USART1_IRQn 1 */</span><br><span class=line>}</span><br></pre></table></figure><h2 id=串口调试助手>串口调试助手</h2><p>我用了xcom和sscom串口调试助手<ul><li>Xcom.exe中可以监视数据传输<li>DTR(Data Terminal Ready（数据终端准备好）)：由数据终端设备（如计算机）发出，表示它已经准备好接收数据了。当DTR为高电平时，表示数据终端设备已经打开了串口，并且可以接收数据。当DTR为低电平时，表示数据终端设备已经关闭了串口，或者不想接收数据了。<li>RTS(Request To Send（请求发送）)：由数据终端设备发出，表示它想要发送数据了，并且请求对方的许可。当RTS为高电平时，表示数据终端设备有数据要发送，并且等待对方的应答。当RTS为低电平时，表示数据终端设备没有数据要发送，或者暂停发送数据。</ul><h2 id=一些经验>一些经验</h2><p>总结下来就是遇到串口不能使用的情况应该检查以下问题：<p>（1）看看串口有没有和其他串口冲突或者被占用<p>（2）代码有没有问题，实在不行先烧官方例程看看<p>（3）检查波特率，停止位，数据位，奇偶校验位这些什么的，一定要选对<blockquote><p>Tips:对照Cube MX中的设置检查</blockquote><p>（4）还有就是要勾选<strong>use micro lib</strong>。<h2 id=bonus>BONUS</h2><ul><li><p>uint8_t_16_t_t_t</p> <ul><li><p>这些类型的来源：这些数据类型中都带有_t, _t 表示这些数据类型是通过typedef定义的，而不是新的数据类型。也就是说，它们其实是我们已知的类型的别名。<li><p>使用这些类型的原因：方便代码的维护。比如，在C中没有bool型，于是在一个软件中，一个程序员使用int，一个程序员使用short，会比较混乱。最好用一个typedef来定义一个统一的bool</p> <figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre><td class=code><pre><span class=line>typedef char bool;</span><br><span class=line>typedef unsigned char           uint8_t;</span><br></pre></table></figure><li><p>uint8_t实际上是一个char。所以输出uint8_t类型的变量实际上输出其对应的字符，而不是数值。</ul><li><p>句柄与普通指针的区别在于，指针包含的是引用对象的内存地址，而句柄则是由系统所管理的引用标识，该标识可以被系统重新定位到一个内存地址上。这种间接访问对象的模式增强了系统对引用对象的控制。句柄本质就是对底层硬件的指针的使用。句柄是针对内核的。大家可以理解为句柄是一个指向指针的指针。</ul><h1 id=problem>Problem</h1><p>在前面两个使用EXTI中断的projects中没能收到USART传来的消息？？？<p>在最后的DMA中断中收到了<figure><img alt=88a583cc4036de8ace38c8517d0075d src=C:\Users\Immortal\AppData\Local\Temp\WeChat%20Files\88a583cc4036de8ace38c8517d0075d.jpg><figcaption aria-hidden=true>88a583cc4036de8ace38c8517d0075d</figcaption></figure><h1 id=references>References</h1><ul><li><p>哈工深电控内训<li><p><a href=https://blog.csdn.net/weixin_56321457/article/details/124206957 rel=noopener target=_blank>STM32用XCOM调试助手打印不出数据_xcom串口调试助手_山野的风.的博客-CSDN博客</a><li><p><a href=https://www.cnblogs.com/ChurF-Lin/p/10793111.html rel=noopener target=_blank>基于STM32之UART串口通信协议（一）详解 - LLLIN000 - 博客园 (cnblogs.com)</a><li><p><a href=https://blog.csdn.net/weixin_43281206/article/details/116279189 rel=noopener target=_blank>STM32串口通信详解以及通信异常或者卡死常见问题分析_stm32 串口传数据互相 干扰_“星云-视界”的博客-CSDN博客</a></ul></div><div><ul class=post-copyright><li class=post-copyright-author><strong>本文作者： </strong>Immortal-Fates<li class=post-copyright-link><strong>本文链接：</strong> <a href=http://example.com/2023/08/22/USART%E5%85%A5%E9%97%A8/ title=USART入门>http://example.com/2023/08/22/USART入门/</a><li class=post-copyright-license><strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href=https://creativecommons.org/licenses/by-nc-sa/4.0/ rel=noopener target=_blank><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！</ul></div><footer class=post-footer><div class=post-tags><a href=/tags/%E5%B5%8C%E5%85%A5%E5%BC%8F/ rel=tag># 嵌入式</a><a href=/tags/robomaster/ rel=tag># robomaster</a></div><div class=post-nav><div class=post-nav-item><a href=/2023/08/21/EXTI%E5%85%A5%E9%97%A8/ rel=prev title=EXTI入门> <i class="fa fa-chevron-left"></i> EXTI入门 </a></div><div class=post-nav-item><a href=/2023/08/22/TIM%E5%85%A5%E9%97%A8/ rel=next title=TIM入门> TIM入门 <i class="fa fa-chevron-right"></i> </a></div></div></footer></article></div><script>window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div><aside class=sidebar><div class=sidebar-inner><ul class="sidebar-nav motion-element"><li class=sidebar-nav-toc>文章目录<li class=sidebar-nav-overview>站点概览</ul><!--noindex--><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class=nav><li class="nav-item nav-level-1"><a class=nav-link href=#main-takeaway><span class=nav-number>1.</span> <span class=nav-text>Main Takeaway</span></a><li class="nav-item nav-level-1"><a class=nav-link href=#usart><span class=nav-number>2.</span> <span class=nav-text>USART</span></a><ol class=nav-child><li class="nav-item nav-level-2"><a class=nav-link href=#%E7%AE%80%E4%BB%8B><span class=nav-number>2.1.</span> <span class=nav-text>简介</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#usart%E7%9A%84%E9%80%9A%E4%BF%A1%E5%8D%8F%E8%AE%AE><span class=nav-number>2.2.</span> <span class=nav-text>USART的通信协议</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#usart%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86><span class=nav-number>2.3.</span> <span class=nav-text>USART工作原理</span></a><ol class=nav-child><li class="nav-item nav-level-3"><a class=nav-link href=#fifo-%E6%93%8D%E4%BD%9C><span class=nav-number>2.3.1.</span> <span class=nav-text>FIFO 操作</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#%E5%8F%91%E9%80%81%E6%8E%A5%E6%94%B6><span class=nav-number>2.3.2.</span> <span class=nav-text>发送接收</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#%E6%95%B0%E6%8D%AE%E6%94%B6%E5%8F%91%E8%BF%87%E7%A8%8B><span class=nav-number>2.3.3.</span> <span class=nav-text>数据收发过程</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#%E6%B3%A2%E7%89%B9%E7%8E%87><span class=nav-number>2.3.4.</span> <span class=nav-text>波特率</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#%E4%B8%AD%E6%96%AD%E6%8E%A7%E5%88%B6><span class=nav-number>2.3.5.</span> <span class=nav-text>中断控制</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#%E4%BD%BF%E7%94%A8dma%E6%94%B6%E5%8F%91><span class=nav-number>2.3.6.</span> <span class=nav-text>使用DMA收发</span></a></ol><li class="nav-item nav-level-2"><a class=nav-link href=#usart%E9%87%8D%E8%A6%81%E5%AF%84%E5%AD%98%E5%99%A8><span class=nav-number>2.4.</span> <span class=nav-text>USART重要寄存器</span></a><ol class=nav-child><li class="nav-item nav-level-3"><a class=nav-link href=#%E7%8A%B6%E6%80%81%E5%AF%84%E5%AD%98%E5%99%A8usart_sr><span class=nav-number>2.4.1.</span> <span class=nav-text>状态寄存器（USART_SR）</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#%E6%8E%A7%E5%88%B6%E5%AF%84%E5%AD%98%E5%99%A8-usart_crx><span class=nav-number>2.4.2.</span> <span class=nav-text>控制寄存器 （USART_CRx）</span></a></ol><li class="nav-item nav-level-2"><a class=nav-link href=#usart-api><span class=nav-number>2.5.</span> <span class=nav-text>USART API</span></a><ol class=nav-child><li class="nav-item nav-level-3"><a class=nav-link href=#%E6%8E%A5%E6%94%B6><span class=nav-number>2.5.1.</span> <span class=nav-text>接收</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#%E5%8F%91%E9%80%81><span class=nav-number>2.5.2.</span> <span class=nav-text>发送</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#%E4%B8%AD%E6%96%AD><span class=nav-number>2.5.3.</span> <span class=nav-text>中断</span></a></ol></ol><li class="nav-item nav-level-1"><a class=nav-link href=#%E5%AE%9E%E9%AA%8C><span class=nav-number>3.</span> <span class=nav-text>实验</span></a><ol class=nav-child><li class="nav-item nav-level-2"><a class=nav-link href=#cubemx><span class=nav-number>3.1.</span> <span class=nav-text>CubeMX：</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#keil><span class=nav-number>3.2.</span> <span class=nav-text>Keil</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#%E4%B8%B2%E5%8F%A3%E8%B0%83%E8%AF%95%E5%8A%A9%E6%89%8B><span class=nav-number>3.3.</span> <span class=nav-text>串口调试助手</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#%E4%B8%80%E4%BA%9B%E7%BB%8F%E9%AA%8C><span class=nav-number>3.4.</span> <span class=nav-text>一些经验</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#bonus><span class=nav-number>3.5.</span> <span class=nav-text>BONUS</span></a></ol><li class="nav-item nav-level-1"><a class=nav-link href=#problem><span class=nav-number>4.</span> <span class=nav-text>Problem</span></a><li class="nav-item nav-level-1"><a class=nav-link href=#references><span class=nav-number>5.</span> <span class=nav-text>References</span></a></ol></div></div><!--/noindex--><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop=author itemscope itemtype=http://schema.org/Person><img alt=Immortal-Fates class=site-author-image itemprop=image src=/images/kuang.jpg><p class=site-author-name itemprop=name>Immortal-Fates<div class=site-description itemprop=description>愿你生命中有更多的云翳，来造就一个美丽的黄昏</div></div><div class="site-state-wrap motion-element"><nav class=site-state><div class="site-state-item site-state-posts"><a href=/archives/> <span class=site-state-item-count>51</span> <span class=site-state-item-name>日志</span> </a></div><div class="site-state-item site-state-categories"><a href=/categories/> <span class=site-state-item-count>7</span> <span class=site-state-item-name>分类</span></a></div><div class="site-state-item site-state-tags"><a href=/tags/> <span class=site-state-item-count>13</span> <span class=site-state-item-name>标签</span></a></div></nav></div></div></div></aside><div id=sidebar-dimmer></div></div></main><footer class=footer><div class=footer-inner><div class=copyright>© <span itemprop=copyrightYear>2024</span><span class=with-love> <i class="fa fa-heart"></i> </span><span class=author itemprop=copyrightHolder>Immortal-Fates</span></div><div class=powered-by><!--由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动 --></div><script async src=http://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js></script><span id=busuanzi_container_site_pv>总访问量<span id=busuanzi_value_site_pv></span>次</span><span class=post-meta-divider>|</span><span id=busuanzi_container_site_uv>总访客数<span id=busuanzi_value_site_uv></span>人</span><span class=post-meta-divider>|</span><!-- 不蒜子计数初始值纠正 --><script>$(document).ready(function() {

    var int = setInterval(fixCount, 50);  // 50ms周期检测函数
    var countOffset = 20000;  // 初始化首次数据

    function fixCount() {            
       if (document.getElementById("busuanzi_container_site_pv").style.display != "none")
        {
            $("#busuanzi_value_site_pv").html(parseInt($("#busuanzi_value_site_pv").html()) + countOffset); 
            clearInterval(int);
        }                  
        if ($("#busuanzi_container_site_pv").css("display") != "none")
        {
            $("#busuanzi_value_site_uv").html(parseInt($("#busuanzi_value_site_uv").html()) + countOffset); // 加上初始数据 
            clearInterval(int); // 停止检测
        }  
    }
       	
});</script><div class=busuanzi-count><script async src=https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><span style="display: none;" class=post-meta-item id=busuanzi_container_site_uv> <span class=post-meta-item-icon> <i class="fa fa-user"></i> </span> <span class=site-uv title=总访客量> <span id=busuanzi_value_site_uv></span> </span> </span><span class=post-meta-divider>|</span><span style="display: none;" class=post-meta-item id=busuanzi_container_site_pv> <span class=post-meta-item-icon> <i class="fa fa-eye"></i> </span> <span class=site-pv title=总访问量> <span id=busuanzi_value_site_pv></span> </span> </span></div></div></footer></div><script color=0,0,255 count=99 opacity=0.5 src=/lib/canvas-nest/canvas-nest.min.js zindex=-1></script><script src=/lib/anime.min.js></script><script src=/lib/velocity/velocity.min.js></script><script src=/lib/velocity/velocity.ui.min.js></script><script src=/js/utils.js></script><script src=/js/motion.js></script><script src=/js/schemes/pisces.js></script><script src=/js/next-boot.js></script><script src=/js/local-search.js></script><script>if (typeof MathJax === 'undefined') {
    window.MathJax = {
      loader: {
        source: {
          '[tex]/amsCd': '[tex]/amscd',
          '[tex]/AMScd': '[tex]/amscd'
        }
      },
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              let target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    (function () {
      var script = document.createElement('script');
      script.src = '//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
      script.defer = true;
      document.head.appendChild(script);
    })();
  } else {
    MathJax.startup.document.state(0);
    MathJax.texReset();
    MathJax.typeset();
  }</script>